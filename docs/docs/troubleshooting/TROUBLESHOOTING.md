# Troubleshooting tips

This guide contains general tips on how to investigate an application deployment that doesn't work correctly.

### AWS Access
#### Symptom

```
Terraform uses 'config.tfvars' to install the infrastructure.
Verifying the config file.
Cleaning all the generated terraform state variable and backend file.
ngh-bamboo' infrastructure deployment is started using config.tfvars.
Terraform state backend/variable files are missing.

An error occurred (ExpiredToken) when calling the GetCallerIdentity operation: The security token included in the request is expired
```
#### Solution
Terraform cannot deploy resources into the AWS cloud if your security token has expired. You will need to renew your token and retry.

### Auto Scaling groups
If the Auto Scaling Group get suspended for any reason, you cannot complete uninstall process.
#### Symptom
```
Error: error waiting for EKS Node Group (atlassian-dc-ngh-bamboo-cluster:appNode) to delete: unexpected state 'DELETE_FAILED', wanted target ''. last error: 1 error occurred:
â”‚ 	* eks-appNode-b8bea4ff-f6a9-36c5-43fc-2bf0449a257c: AutoScalingGroupInvalidConfiguration: Couldn't terminate instances in ASG as Terminate process is suspended
```
#### solution
Open the AWS console and find the EKS cluster related to the environment. 
Find the Auto Scaling Group and [resume the suspension](https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-suspend-resume-processes.html){.exterlan} then re-run uninstall. 

### Unlock Terraform state
If user interrupts the execution of install or uninstall actions, Terraform never get a chance to unlock the locked resources. 
In this case Terraform cannot capture the lock in next attempt.
 
#### Symptom

```
Acquiring state lock. This may take a few moments...

 Error: Error acquiring the state lock

 Error message: ConditionalCheckFailedException: The conditional request failed
 Lock Info:
   ID:        26f7b9a8-4bef-0674-669b-1d90800dea4d
   Path:      atlassian-data-center-terraform-state-xxxxxxxxxx/bamboo-xxxxxxxxxx/terraform.tfstate
   Operation: OperationTypeApply
   Who:       nghazalibeiklar@C02CK0JYMD6V
   Version:   1.0.9
   Created:   2021-11-04 00:50:34.736134 +0000 UTC
   Info:


 Terraform acquires a state lock to protect the state from being written
 by multiple users at the same time. Please resolve the issue above and try
 again. For most commands, you can disable locking with the "-lock=false"
 flag, but this is not recommended.

```
#### Solution
To fix this you need to unlock state first by running the following command 
(replace ID with the value from the error message):

```shell 
terraform force-unlock <ID>
```

!!! hint "Are you still having the lock problem after running `terraform force-unlock`?"
    There are two terraform locks, one for infrastructure and another for terraform state. If running the following 
    command from repo folder does not unlock the resources, then change the current path to `./pkg/tfstate` and retry
     the same command.  


### Cleanup Terraform state
Terraform stores the lock and current state in the terraform backend file in `terraform-backend.tf`. 
This file will be generated by the install process based on the content of `config.auto.tfvars`.
If the user changes some key configuration items such as `region` or `environment_name` then you should 
cleanup all temporary files generated by terraform and install modules again. 

To cleanup the local terraform files, run the following command:
```
./pkg/scripts/cleanup.sh
```

